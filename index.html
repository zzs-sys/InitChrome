<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量查询钱包数据</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }
        .address {
            font-size: 12px;
            color: #888;
            overflow-wrap: break-word;
        }
        .loading {
            text-align: center;
            font-weight: bold;
            color: #333;
            display: none;
        }
        .highlight-red {
            background-color: #ffdddd;
        }
        .spinner {
            display: inline-block;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .update-message {
            color: green;
            font-weight: bold;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>批量查询钱包数据</h1>
        <label for="wallets">请输入钱包地址（每行一个地址）:</label>
        <textarea id="wallets" rows="5" placeholder="输入地址，多个地址换行"></textarea><br/>
        <button onclick="batchQuery()">查询</button>
        <button onclick="updateSelectedAddresses()">更新选定地址</button>

        <div id="loading" class="loading">
            <div class="spinner"></div> 正在更新，请稍候...
        </div>
        <div id="update-message" class="update-message">更新成功！</div>

        <div class="result">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" onclick="toggleAll()"></th>
                        <th>钱包编号</th>
                        <th>钱包地址</th>
                        <th>钱包余额 (USD)</th>
                        <th>徽章数量</th>
                        <th>经验值</th>
                        <th>交易次数</th>
                        <th>最后交易时间</th>
                    </tr>
                </thead>
                <tbody id="results"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 转换日期到相对时间（例如: 今天, 1天前, 7天前）
        function formatTime(timestamp) {
            const currentDate = new Date();
            const transactionDate = new Date(timestamp);
            const timeDiff = Math.floor((currentDate - transactionDate) / (1000 * 3600 * 24)); // 天数

            if (timeDiff === 0) {
                return '今天';
            } else if (timeDiff === 1) {
                return '1天前';
            } else if (timeDiff <= 7) {
                return `${timeDiff}天前`;
            } else {
                return `<span class="highlight-red">${timeDiff}天前</span>`;
            }
        }

        async function batchQuery() {
            const addresses = document.getElementById("wallets").value.split("\n").map(addr => addr.trim()).filter(addr => addr);
            if (addresses.length === 0) {
                alert('请输入至少一个钱包地址');
                return;
            }

            const resultsElement = document.getElementById('results');
            const loadingElement = document.getElementById('loading');
            resultsElement.innerHTML = ''; // 清空之前的结果
            loadingElement.style.display = 'block'; // 显示加载提示

            let walletNumber = 1; // 钱包编号，从1开始
            for (let address of addresses) {
                try {
                    // 获取钱包余额
                    const portfolioResponse = await fetch(`https://backend.portal.abs.xyz/api/user/${address}/wallet/balances`);
                    const portfolioData = await portfolioResponse.json();

                    // 获取交易记录
                    const transactionsResponse = await fetch(`https://backend.portal.abs.xyz/api/user/${address}/transactions`);
                    const transactionsData = await transactionsResponse.json();
                    const transactionCount = transactionsData.transactions ? transactionsData.transactions.length : 0;

                    // 获取最后交易时间
                    let lastTransactionDate = '';
                    if (transactionsData.transactions && transactionsData.transactions.length > 0) {
                        lastTransactionDate = transactionsData.transactions[0].timestamp;
                    }

                    // 获取徽章数量和经验点数
                    const userInfoResponse = await fetch(`https://backend.portal.abs.xyz/api/user/address/${address}`);
                    const userInfoData = await userInfoResponse.json();
                    const totalExperiencePoints = userInfoData.user ? userInfoData.user.totalExperiencePoints : '数据不可用';
                    const badgeCount = userInfoData.user && userInfoData.user.badges ? userInfoData.user.badges.length : 0;

                    // 计算总余额
                    let totalBalance = 0;
                    const tokens = portfolioData.tokens || [];
                    tokens.forEach(token => {
                        totalBalance += token.usdValue || 0;
                    });

                    // 处理结果
                    const resultRow = document.createElement('tr');
                    resultRow.innerHTML = `
                        <td><input type="checkbox" class="select-address" data-address="${address}"></td>
                        <td>${walletNumber}</td>
                        <td class="address">${address}</td>
                        <td>$${totalBalance.toFixed(2)}</td>
                        <td>${badgeCount}</td>
                        <td>${totalExperiencePoints}</td>
                        <td>${transactionCount}</td>
                        <td>${formatTime(lastTransactionDate)}</td>
                    `;
                    resultsElement.appendChild(resultRow);
                    walletNumber++; // 更新钱包编号
                } catch (error) {
                    const resultRow = document.createElement('tr');
                    resultRow.innerHTML = `
                        <td>${walletNumber}</td>
                        <td class="address">${address}</td>
                        <td colspan="6">查询失败: ${error.message}</td>
                    `;
                    resultsElement.appendChild(resultRow);
                    walletNumber++; // 更新钱包编号
                }
            }

            loadingElement.style.display = 'none'; // 隐藏加载提示
        }

        // 更新选定地址数据
        function updateSelectedAddresses() {
            const selectedAddresses = [];
            const checkboxes = document.querySelectorAll('.select-address:checked');
            checkboxes.forEach(checkbox => {
                selectedAddresses.push(checkbox.getAttribute('data-address'));
            });

            if (selectedAddresses.length === 0) {
                alert('请至少选择一个地址进行更新');
                return;
            }

            // 显示正在更新的状态
            document.getElementById('loading').style.display = 'block';
            document.getElementById('update-message').style.display = 'none';

            // 模拟更新操作
            setTimeout(() => {
                // 这里可以调用更新接口或做其他处理
                document.getElementById('loading').style.display = 'none';
                document.getElementById('update-message').style.display = 'block'; // 显示更新成功消息
            }, 2000); // 模拟2秒的延时
        }

        // 全选/全不选功能
        function toggleAll() {
            const checkboxes = document.querySelectorAll('.select-address');
            const isChecked = document.querySelector('input[type="checkbox"]').checked;
            checkboxes.forEach(checkbox => checkbox.checked = isChecked);
        }
    </script>
</body>
</html>
